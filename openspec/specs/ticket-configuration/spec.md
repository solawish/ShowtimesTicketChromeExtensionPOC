## Purpose
在 Chrome Extension 的 popup 介面中提供五個級聯下拉選單，讓使用者依序選擇購票所需的各項參數（電影、場地、時間、票種、數量），以便後續自動化購票流程。
## Requirements
### Requirement: 購票配置介面
系統 SHALL 在 Chrome Extension 的 popup 介面中提供五個級聯下拉選單，讓使用者依序選擇電影、場地、時間、票種、數量。

#### Scenario: 開啟 popup 介面
- **WHEN** 使用者點擊 Extension 圖示開啟 popup
- **THEN** 顯示包含五個下拉選單的介面
- **AND** 電影選單為啟用狀態，其他選單為禁用狀態
- **AND** 數量選單為啟用狀態，顯示選項 1 到 6（顯示值為 `1`, `2`, `3`, `4`, `5`, `6`，選項值也為對應的數字）
- **AND** 數量選單預設值為 1

#### Scenario: 選擇電影
- **WHEN** 使用者從電影下拉選單中選擇一部電影
- **THEN** 顯示載入狀態提示（例如：載入中...）
- **AND** 呼叫場地與時間 API `GET https://capi.showtimes.com.tw/1/events/listForProgram/{programId}?date={date}&forVista=false`（使用選定的電影 ID 作為 programId，使用今天的日期作為 date，格式為 `YYYY-MM-DD`，例如：`2026-01-14`）
- **AND** 場地下拉選單變為啟用狀態
- **AND** 場地選單載入 `payload.venues[]` 中的場地選項（使用 `venue.name` 作為顯示，`venue.id` 作為值）
- **AND** 時間、票種選單保持禁用狀態並清空選項
- **AND** 數量選單保持啟用狀態（不受影響）
- **AND** 所有下層選單的內部狀態（config 值）被重置為 null 或預設值（數量除外）

#### Scenario: 選擇場地
- **WHEN** 使用者已選擇電影並從場地下拉選單中選擇一個場地
- **THEN** 時間下拉選單變為啟用狀態
- **AND** 時間選單從已載入的 `payload.events[]` 中過濾出 `event.venueId === 選定的場地ID` 且 `event.status === "active"` 的場次
- **AND** 使用 `event.startedAt` 轉換為 GMT+8 時區格式（例如：`2026-01-17 13:45`）作為顯示，`event.id` 作為值
- **AND** 票種選單保持禁用狀態並清空選項
- **AND** 數量選單保持啟用狀態（不受影響）
- **AND** 所有下層選單的內部狀態（config 值）被重置為 null 或預設值（數量除外）

#### Scenario: 選擇時間
- **WHEN** 使用者已選擇電影、場地並從時間下拉選單中選擇一個時間
- **THEN** 顯示載入狀態提示（例如：載入中...）
- **AND** 呼叫票種 API `GET https://capi.showtimes.com.tw/1/ticketTypes/forEvent/{eventId}?includeGroupTicket=true&includeMemberRedeem=true&version=03.00.00`（使用選定的時間 ID 作為 eventId）
- **AND** 票種下拉選單變為啟用狀態
- **AND** 票種選單載入 `payload.ticketTypes[]` 中的票種選項（使用 `ticketType.title` 作為顯示，`ticketType.category` 作為值）
- **AND** 數量選單保持啟用狀態（不受影響）
- **AND** 所有下層選單的內部狀態（config 值）被重置為 null 或預設值（數量除外）
- **AND** 載入完成後隱藏載入提示

#### Scenario: 選擇票種
- **WHEN** 使用者已選擇電影、場地、時間並從票種下拉選單中選擇一個票種
- **THEN** 數量下拉選單保持啟用狀態（不受影響）

#### Scenario: 變更前置選擇
- **WHEN** 使用者變更已選擇的電影、場地、時間或票種
- **THEN** 所有後續選單的選擇被清空（數量選單除外）
- **AND** 所有後續選單的內部狀態（config 值）被重置為 null 或預設值（數量除外）
- **AND** 後續選單根據新的前置選擇重新載入選項
- **AND** 被清空的選單變為禁用狀態（直到新的前置選擇完成，數量選單除外）
- **AND** 數量選單保持啟用狀態（不受影響）
- **AND** 重置後的狀態立即儲存到 Chrome Storage，避免舊值被恢復

### Requirement: 票種重新讀取功能
系統 SHALL 在票種下拉選單旁邊提供一個「重新讀取」按鈕，讓使用者可以手動重新載入票種資料。

#### Scenario: 顯示重新讀取按鈕
- **WHEN** 使用者已選擇時間且票種選單已啟用
- **THEN** 「重新讀取」按鈕顯示在票種下拉選單旁邊
- **AND** 按鈕為啟用狀態（可點擊）

#### Scenario: 按鈕禁用狀態
- **WHEN** 使用者尚未選擇時間或票種選單為禁用狀態
- **THEN** 「重新讀取」按鈕為禁用狀態（不可點擊）

#### Scenario: 重新載入票種資料
- **WHEN** 使用者點擊「重新讀取」按鈕
- **THEN** 顯示載入狀態提示（例如：載入中...）
- **AND** 呼叫票種 API `GET https://capi.showtimes.com.tw/1/ticketTypes/forEvent/{eventId}?includeGroupTicket=true&includeMemberRedeem=true&version=03.00.00`（使用當前選定的時間 ID 作為 eventId，不使用快取，每次重新獲取）
- **AND** 更新票種下拉選單的選項
- **AND** 如果當前選定的票種仍存在於新的資料中，則保留該選擇
- **AND** 如果當前選定的票種不存在於新的資料中，則清空選擇並顯示預設選項
- **AND** 載入完成後隱藏載入狀態提示

#### Scenario: 重新載入失敗
- **WHEN** 使用者點擊「重新讀取」按鈕但 API 呼叫失敗
- **THEN** 顯示錯誤訊息（例如：「載入失敗，請稍後再試」）
- **AND** 隱藏載入狀態提示
- **AND** 票種選單保持當前狀態（不變更選項）

### Requirement: 票種關鍵詞與自動選票
系統 SHALL 在「時間」與「票種」選單之間提供「票種關鍵詞」輸入框與一組勾選框；選擇時間後仍先呼叫票種 API 並列出票種。當勾選框勾選時，系統 SHALL 要求「票種關鍵詞」輸入框必須有值（trim 後非空），否則訂票按鈕應保持禁用狀態；當使用者按下「訂票」且勾選時，先呼叫票種 API、依先排除老人與愛心票種，然後關鍵字 → 全票 → 單人套票 → 第一個之順序自動選出票種，再繼續後續訂票流程，並在勾選時於 UI 顯示說明文字。

#### Scenario: 顯示票種關鍵詞區塊
- **WHEN** 使用者開啟 popup 或已選擇時間
- **THEN** 在「時間」form-group 與「票種」form-group 之間顯示「票種關鍵詞」輸入框與勾選框（例如：啟用依關鍵詞自動選票）
- **AND** 輸入框與勾選框的狀態可被儲存與恢復（例如透過 Chrome Storage）

#### Scenario: 勾選時顯示說明
- **WHEN** 使用者勾選「依關鍵詞自動選票」勾選框
- **THEN** 在該區塊內或下方顯示說明文字，說明啟用後將在按下訂票時依關鍵字或預設優先順序（先排除老人／愛心，然後關鍵字 → 全票 → 單人套票 → 第一個）自動選擇票種後再繼續流程
- **AND** 當使用者取消勾選時，該說明文字隱藏或不再強調顯示

#### Scenario: 選擇時間後仍列出票種
- **WHEN** 使用者已選擇電影、場地並從時間下拉選單中選擇一個時間
- **THEN** 系統仍照常呼叫票種 API 並將票種填入票種下拉選單（與現有「選擇時間」行為一致）
- **AND** 票種選單顯示所有取得的票種供使用者參考，不因勾選框狀態而改變此列出行為

#### Scenario: 勾選時關鍵字必填
- **WHEN** 勾選框已勾選但「票種關鍵詞」輸入框為空（trim 後無字元）
- **THEN** 訂票按鈕保持禁用狀態
- **AND** 系統顯示適當的提示訊息（例如：在輸入框下方顯示「請輸入關鍵詞」或類似提示），提醒使用者必須輸入關鍵詞才能啟用自動選票功能

#### Scenario: 勾選時忽視票種必須選擇之限制
- **WHEN** 勾選框已勾選且「票種關鍵詞」輸入框有值（trim 後非空），且使用者已選擇電影、場地、時間
- **THEN** 系統不要求使用者必須在票種下拉選單中手動選擇票種
- **AND** 訂票按鈕在滿足其他條件（由實作定義）時可啟用，即允許在未手動選擇票種的情況下按下訂票

#### Scenario: 未勾選時維持既有訂票條件
- **WHEN** 勾選框未勾選，或「票種關鍵詞」輸入框為空（trim 後無字元）
- **THEN** 訂票按鈕之啟用條件與現有行為一致，即仍須在票種選單中手動選擇票種後始可訂票

#### Scenario: 訂票按下後先呼叫 API 再自動選票
- **WHEN** 使用者按下「訂票」按鈕且勾選框已勾選且「票種關鍵詞」有值（trim 後非空）
- **THEN** 系統先呼叫票種 API（`GET https://capi.showtimes.com.tw/1/ticketTypes/forEvent/{eventId}?...`，使用當前選定的 eventId）
- **AND** 取得票種列表後，先排除名稱（title）中含有「老人」或「愛心」的票種，然後依關鍵字 → 全票 → 單人套票 → 第一個之順序選出一個票種
- **AND** 若選出票種，則以該票種與當前數量繼續後續訂票流程（取得座位、鎖位等）；若無符合票種則不繼續流程並顯示適當錯誤或提示

#### Scenario: 自動選票邏輯先排除老人與愛心
- **WHEN** 訂票流程中執行自動選票且取得票種列表後
- **THEN** 系統先過濾票種列表，排除名稱（title）中含有「老人」或「愛心」的票種
- **AND** 後續的選票邏輯（關鍵字匹配、全票、單人套票、第一個）僅在過濾後的票種列表中執行

#### Scenario: 自動選票邏輯關鍵字優先
- **WHEN** 訂票流程中執行自動選票且已排除老人與愛心票種後
- **THEN** 系統先以「票種關鍵詞」搜尋過濾後票種名稱（ticketType.title）包含該關鍵字的票種
- **AND** 若有符合者，選取第一個符合的票種並以此繼續流程

#### Scenario: 自動選票 Fallback 全票
- **WHEN** 依關鍵字搜尋後無符合票種（在已排除老人與愛心的列表中）
- **THEN** 系統改為選取名稱（title）中含有「全票」的票種之第一個
- **AND** 若有符合者，以該票種繼續流程

#### Scenario: 自動選票 Fallback 單人套票
- **WHEN** 依關鍵字與「全票」皆無符合票種（在已排除老人與愛心的列表中）
- **THEN** 系統改為選取名稱（title）中含有「單人套票」的票種之第一個
- **AND** 若有符合者，以該票種繼續流程

#### Scenario: 自動選票 Fallback 取第一個
- **WHEN** 依關鍵字、「全票」、「單人套票」皆無符合票種（在已排除老人與愛心的列表中）
- **THEN** 系統自剩餘票種中選取第一個
- **AND** 若有剩餘票種，以該第一個繼續流程；若無剩餘票種（所有票種都是老人或愛心票）則不繼續流程並顯示適當錯誤或提示

